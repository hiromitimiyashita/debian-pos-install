#!/bin/bash

# ==============================================================================
# Este script automatiza a instalação da Steam e dos drivers gráficos
# para NVIDIA, AMD ou Intel, com uma interface clara e tratamento de erros.
# ==============================================================================

# --- Configuração de Robustez ---
set -e
set -o pipefail
trap 'error_handler $? $LINENO' ERR

# --- Funções Globais de Log e Erro ---
log_step() { echo -e "\n\e[1;35m>>> PASSO: $1\e[0m"; }
log_success() { echo -e "\e[1;32m[SUCESSO] $1\e[0m"; }
log_error() { echo -e "\e[1;31m[ERRO] $1\e[0m" >&2; }
log_info() { echo -e "\e[1;34m[INFO] $1\e[0m"; }
log_warning() { echo -e "\e[1;33m[AVISO] $1\e[0m"; }

error_handler() {
    log_error "Ocorreu um erro na linha $2. Código de saída: $1."
    exit 1
}

# --- Funções de Lógica ---

check_permissions() {
    if [ "$(id -u)" -ne 0 ]; then
        log_error "Este script precisa ser executado como root. Por favor, execute com 'sudo $0'"
        exit 1
    fi
}

show_vendor_menu() {
    log_step "Seleção do Fabricante da Placa de Vídeo"

    local PS3="Digite o número correspondente à sua placa de vídeo: "
    local options=("NVIDIA (Driver Proprietário)" "AMD (Driver Open-Source)" "Intel (Driver Open-Source)" "Sair")

    select opt in "${options[@]}"; do
        case $opt in
            "NVIDIA (Driver Proprietário)")
                log_info "Você selecionou NVIDIA."
                DRIVER_PACKAGES=( "nvidia-driver" "firmware-misc-nonfree" )
                break
                ;;
            "AMD (Driver Open-Source)")
                log_info "Você selecionou AMD."
                DRIVER_PACKAGES=( "firmware-amd-graphics" "libgl1-mesa-dri" "libglx-mesa0" "mesa-vulkan-drivers" )
                break
                ;;
            "Intel (Driver Open-Source)")
                log_info "Você selecionou Intel."
                DRIVER_PACKAGES=( "mesa-vulkan-drivers" "intel-media-va-driver" "i965-va-driver" )
                break
                ;;
            "Sair")
                log_info "Operação cancelada pelo usuário."
                exit 0
                ;;
            *) log_warning "Opção inválida: $REPLY. Tente novamente.";;
        esac
    done
}

prepare_repositories() {
    log_step "Preparando Repositórios do Sistema e Arquitetura"

    log_info "Configurando os repositórios APT (adicionando contrib, non-free, non-free-firmware)..."
    
    # Este comando 'sed' substitui de forma inteligente toda a seção de componentes
    # nas linhas 'deb' e 'deb-src', garantindo a sequência correta.
    sed -i -E 's#^(deb(-src)?\s+[^ ]+\s+[^ ]+)\s+.*#\1 main contrib non-free non-free-firmware#' /etc/apt/sources.list

    log_info "Habilitando a arquitetura i386 (necessária para a Steam)..."
    dpkg --add-architecture i386

    log_info "Atualizando a lista de pacotes..."
    apt update

    log_success "Repositórios e arquitetura i386 configurados."
}

install_packages() {
    log_step "Instalando a Steam e os Drivers Gráficos"

    local COMMON_PACKAGES=( "steam-installer" "linux-headers-$(uname -r)" )
    local ALL_PACKAGES=("${COMMON_PACKAGES[@]}" "${DRIVER_PACKAGES[@]}")

    log_info "Os seguintes pacotes serão instalados:"
    for pkg in "${ALL_PACKAGES[@]}"; do
        echo "    - $pkg"
    done
    echo ""
    read -p "Pressione Enter para continuar com a instalação ou Ctrl+C para cancelar..."

    apt install -y "${ALL_PACKAGES[@]}"
    log_success "Todos os pacotes foram instalados com sucesso."
}

# --- Função Principal ---
main() {
    clear
    check_permissions

    echo "==========================================================="
    echo "  Instalador da Steam e Drivers Gráficos para Debian"
    echo "==========================================================="

    show_vendor_menu
    prepare_repositories
    install_packages

    # --- Finalização ---
    echo
    log_step "INSTALAÇÃO E CONFIGURAÇÃO CONCLUÍDAS!"
    log_info "A Steam e os drivers gráficos foram instalados."
    log_warning "É ALTAMENTE RECOMENDÁVEL reiniciar o computador agora para que os novos drivers sejam carregados corretamente."
    echo

    read -p "Deseja reiniciar agora? (S/n): " reboot_choice
    if [[ "${reboot_choice:-s}" =~ ^[Ss]$ ]]; then
        log_info "Reiniciando o sistema em 5 segundos..."
        sleep 5
        reboot
    else
        log_info "Lembre-se de reiniciar o sistema manualmente mais tarde."
        log_info "Você pode encontrar a Steam no seu menu de aplicativos."
    fi
}

# --- Ponto de Entrada do Script ---
main
