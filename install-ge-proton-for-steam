#!/bin/bash

# ==============================================================================
# Este script automatiza o download e a instalação do GE-Proton, detectando
# automaticamente o diretório da Steam (Nativo, Flatpak) e usando 'jq' para
# uma análise robusta da API do GitHub.
# ==============================================================================

# --- Configuração de Robustez ---
# Ativa o modo de segurança: sai em caso de erro, erro em pipes, e trata variáveis não definidas como erro.
set -euo pipefail

# --- Funções Globais de Log ---
log_step() { echo -e "\n\e[1;35m>>> PASSO: $1\e[0m"; }
log_success() { echo -e "\e[1;32m[SUCESSO] $1\e[0m"; }
log_error() { echo -e "\e[1;31m[ERRO] $1\e[0m" >&2; }
log_info() { echo -e "\e[1;34m[INFO] $1\e[0m"; }

# --- Funções de Lógica ---

check_permissions() {
    log_step "Verificando permissões de execução"
    # Este script deve ser executado pelo usuário, NÃO como root/sudo.
    if [ "$(id -u)" -eq 0 ]; then
        log_error "Este script NÃO deve ser executado com 'sudo' ou como usuário root."
        log_error "Ele manipula arquivos na sua pasta pessoal e precisa ser executado como o seu usuário normal."
        log_info "Por favor, execute o script sem 'sudo'. Exemplo: ./seu_script.sh"
        exit 1
    fi
    log_success "Script executado com as permissões corretas (usuário normal)."
}
check_dependencies() {
    log_step "Verificando dependências necessárias"
    local missing_deps=0
    for cmd in curl jq sha512sum tar; do
        if ! command -v "$cmd" &> /dev/null; then
            log_error "Dependência não encontrada: '$cmd'. Por favor, instale-a."
            missing_deps=1
        fi
    done

    if [ "$missing_deps" -eq 1 ]; then
        log_error "Uma ou mais dependências não foram encontradas. Em sistemas Debian, instale com: sudo apt install curl jq"
        exit 1
    fi
    log_success "Todas as dependências foram encontradas."
}

find_steam_dir() {

# Array de possíveis diretórios base da Steam, em ordem de prioridade.
    # A sua descoberta do caminho '.steam/debian-installation' foi crucial e adicionada aqui.
    local steam_paths=(
        "$HOME/.var/app/com.valvesoftware.Steam/data/Steam"  # 1. Prioridade para Flatpak
        "$HOME/.steam/debian-installation"                  # 2. Prioridade para a instalação via APT no Debian (o seu caso)
        "$HOME/.steam/root"                                 # 3. Fallback para instalações nativas
        "$HOME/.steam/steam"                                # 4. Fallback final para instalações nativas
    )

    local found_path=""
    # Loop para verificar cada caminho potencial
    for path in "${steam_paths[@]}"; do
        log_info "Verificando o caminho: ${path}..."
        # Verifica se o caminho existe E é um diretório
        if [ -d "$path" ]; then
            found_path="$path"
            log_info "Diretório base da Steam encontrado em: $found_path"
            break # Sai do loop assim que encontrar o caminho válido
        fi
    done

    # Se, após o loop, nenhum caminho for encontrado, o script falha com uma mensagem clara.
    if [ -z "$found_path" ]; then
        log_error "Não foi possível encontrar um diretório de instalação do Steam válido e funcional."
        log_error "Dica: Verifique se a Steam já foi executada pelo menos uma vez para criar seus diretórios."
        exit 1
    fi

    # Define o diretório final para as ferramentas de compatibilidade
    STEAM_DIR_TARGET="${found_path}/compatibilitytools.d"
    mkdir -p "$STEAM_DIR_TARGET"
    log_success "Diretório de destino para o GE-Proton: $STEAM_DIR_TARGET"

}

fetch_release_info() {
    log_step "Buscando a versão mais recente do GE-Proton"
    local API_URL="https://api.github.com/repos/GloriousEggroll/proton-ge-custom/releases/latest"

    log_info "Consultando a API do GitHub..."
    # Faz uma única chamada à API e guarda a resposta
    API_RESPONSE=$(curl -s "$API_URL")

    # Usa 'jq' para extrair os URLs de forma segura e robusta
    TARBALL_URL=$(echo "$API_RESPONSE" | jq -r '.assets[] | select(.name | endswith(".tar.gz")) | .browser_download_url')
    CHECKSUM_URL=$(echo "$API_RESPONSE" | jq -r '.assets[] | select(.name | endswith(".sha512sum")) | .browser_download_url')

    if [ -z "$TARBALL_URL" ] || [ -z "$CHECKSUM_URL" ]; then
        log_error "Não foi possível obter os URLs de download da API do GitHub. Verifique sua conexão."
        exit 1
    fi

    TARBALL_NAME=$(basename "$TARBALL_URL")
    log_success "Encontrada a versão mais recente: $TARBALL_NAME"
}

download_and_verify() {
    log_step "Baixando e verificando os arquivos"

    # Cria um diretório de trabalho temporário seguro
    TMP_DIR=$(mktemp -d)
    cd "$TMP_DIR"
    log_info "Trabalhando no diretório temporário: $TMP_DIR"

    # Função para limpar o diretório temporário ao sair do script
    cleanup() {
        log_info "Limpando arquivos temporários..."
        rm -rf "$TMP_DIR"
    }
    trap cleanup EXIT

    log_info "Baixando: $TARBALL_NAME"
    curl -L -# "$TARBALL_URL" -o "$TARBALL_NAME"

    log_info "Baixando checksum..."
    curl -L -# "$CHECKSUM_URL" -o "checksum.sha512sum"

    log_info "Verificando a integridade do arquivo..."
    # 'cd' para o diretório temporário garante que o sha512sum encontre o arquivo
    (cd "$TMP_DIR" && sha512sum -c "checksum.sha512sum")
    log_success "Verificação de checksum bem-sucedida."
}

install_proton_release() {
    log_step "Instalando o GE-Proton"
    log_info "Extraindo $TARBALL_NAME para o diretório do Steam..."
    tar -xf "$TMP_DIR/$TARBALL_NAME" -C "$STEAM_DIR_TARGET"
    log_success "GE-Proton instalado com sucesso!"
}

# --- Função Principal ---
main() {
    clear
    echo "=========================================="
    echo "  Instalador Automatizado do GE-Proton  "
    echo "=========================================="
check_permissions
    check_dependencies
    find_steam_dir
    fetch_release_info
    download_and_verify
    install_proton_release

  
    log_step "INSTALAÇÃO CONCLUÍDA"
    log_warning "Por favor, reinicie COMPLETAMENTE o cliente Steam para que a nova versão do GE-Proton seja reconhecida."
}

# --- Ponto de Entrada do Script ---
main
