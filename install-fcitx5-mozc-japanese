#!/bin/bash

# ==============================================================================
# Script Melhorado de Instalação do Fcitx5 com Mozc para Debian KDE
# Versão: 2.0
#
# O que ele faz:
# 1. Instala os pacotes Fcitx5/Mozc e todas as dependências necessárias.
# 2. Pergunta ao usuário qual seu layout de teclado para uma configuração inicial correta.
# 3. Define as variáveis de ambiente globais de forma robusta (/etc/environment.d).
# 4. Cria a configuração inicial do Fcitx5 para o usuário, já com seu teclado e o Mozc.
# 5. Integra-se perfeitamente com o Teclado Virtual do KDE Plasma.
# 6. É à prova de falhas, com tratamento de erros e logs claros.
# ==============================================================================

# --- Configuração de Robustez ---
set -e
set -o pipefail
trap 'error_handler $? $LINENO' ERR

# --- Funções Globais de Log e Erro ---
log_step() { echo -e "\n\e[1;35m>>> PASSO: $1\e[0m"; }
log_success() { echo -e "\e[1;32m[SUCESSO] $1\e[0m"; }
log_error() { echo -e "\e[1;31m[ERRO] $1\e[0m" >&2; }
log_info() { echo -e "\e[1;34m[INFO] $1\e[0m"; }
log_warning() { echo -e "\e[1;33m[AVISO] $1\e[0m"; }

error_handler() {
  log_error "Ocorreu um erro na linha $2. Código de saída: $1."
  exit 1
}

# --- Funções de Lógica ---

check_permissions() {
  log_step "Verificando permissões e identificando usuário"
  if [ "$(id -u)" -ne 0 ]; then
    log_error "Este script precisa ser executado com sudo. Ex: sudo ./install-fcitx5-mozc-japanese"
    exit 1
  fi
  # Define o usuário que chamou 'sudo'
  TARGET_USER=${SUDO_USER:-$(logname)}
  if [ -z "$TARGET_USER" ]; then
    log_error "Não foi possível determinar o usuário alvo."
    exit 1
  fi
  log_info "Script sendo executado para o usuário: $TARGET_USER"
}

ask_keyboard_layout() {
  log_step "Configurando layout do teclado"
  read -p "Por favor, digite o código do seu layout de teclado (ex: br, us, de, es, jp) [padrão: us]: " layout
  # Define 'us' como padrão se a entrada for vazia
  KEYBOARD_LAYOUT=${layout:-us}
  log_info "Layout de teclado base a ser usado: keyboard-$KEYBOARD_LAYOUT"
}

install_packages() {
  log_step "Atualizando o sistema e instalando pacotes"
  log_info "Atualizando a lista de pacotes..."
  apt update
  log_info "Instalando Fcitx5, Mozc e módulos de integração..."
  apt install -y fcitx5 fcitx5-configtool fcitx5-mozc fcitx5-frontend-gtk3 fcitx5-frontend-gtk4 fcitx5-frontend-qt5 fcitx5-frontend-qt6 dbus-x11

  log_success "Pacotes essenciais instalados."
}

configure_system_environment() {
  log_step "Configurando variáveis de ambiente globais"
  local CONFIG_FILE="/etc/environment.d/90-fcitx5.conf"
  log_info "Criando arquivo de configuração em $CONFIG_FILE..."
  # Este é o método mais robusto para garantir que o Fcitx5 funcione em todos os aplicativos
  tee "$CONFIG_FILE" >/dev/null <<EOF
GTK_IM_MODULE=fcitx
QT_IM_MODULE=fcitx
XMODIFIERS=@im=fcitx
SDL_IM_MODULE=fcitx
EOF
  log_success "Variáveis de ambiente do sistema configuradas."
}

configure_user_profile() {
  log_step "Criando configuração padrão do Fcitx5 para o usuário"
  local PROFILE_DIR="/home/$TARGET_USER/.config/fcitx5"
  local PROFILE_FILE="$PROFILE_DIR/profile"

  log_info "Criando diretório de configuração $PROFILE_DIR..."
  # Executa o comando como o usuário alvo para garantir permissões corretas
  sudo -u "$TARGET_USER" mkdir -p "$PROFILE_DIR"

  log_info "Criando arquivo de perfil com o teclado 'keyboard-$KEYBOARD_LAYOUT' e 'mozc'..."
  # Usa 'tee' com 'sudo -u' para escrever o arquivo como o usuário alvo
  sudo -u "$TARGET_USER" tee "$PROFILE_FILE" >/dev/null <<EOF
[Profile]
# Perfil Padrão
Name=Default
[InputMethod]
# Lista de Métodos de Entrada Ativos
IMList=keyboard-$KEYBOARD_LAYOUT,mozc
EOF
  log_success "Arquivo de perfil do usuário criado em $PROFILE_FILE."
}

integrate_with_kde() {
  log_step "Integrando Fcitx5 com as Configurações do Sistema do KDE Plasma"
  # Este comando precisa ser executado como o usuário para acessar seu barramento D-Bus e arquivos de config
  if command -v kwriteconfig6 &>/dev/null; then
    log_info "Detectado Plasma 6. Usando kwriteconfig6..."
    sudo -u "$TARGET_USER" dbus-launch kwriteconfig6 --file kcminputrc --group Keyboard --key IMModule fcitx5
    log_success "Teclado Virtual do KDE configurado para Fcitx5."
  elif command -v kwriteconfig5 &>/dev/null; then
    log_info "Detectado Plasma 5. Usando kwriteconfig5..."
    sudo -u "$TARGET_USER" dbus-launch kwriteconfig5 --file kcminputrc --group Keyboard --key IMModule fcitx5
    log_success "Teclado Virtual do KDE configurado para Fcitx5."
  else
    log_warning "'kwriteconfig5/6' não encontrado. Você precisará configurar manualmente."
    echo "Após reiniciar, vá para 'Configurações do Sistema' -> 'Dispositivos de Entrada' -> 'Teclado Virtual' e selecione 'Fcitx 5'."
  fi
}

# --- Função Principal ---
main() {
  clear
  echo "============================================================"
  echo "Iniciando a instalação do Fcitx5 e Mozc para Debian KDE"
  echo "============================================================"

  check_permissions
  ask_keyboard_layout
  install_packages
  configure_system_environment
  configure_user_profile
  integrate_with_kde

  # --- Instruções Finais ---
  echo
  log_step "INSTALAÇÃO CONCLUÍDA"
  log_success "O ambiente de entrada japonês foi configurado."
  log_warning "É ESSENCIAL reiniciar o computador para aplicar todas as alterações."
  echo
  echo "Após reiniciar:"
  echo "-> Use a tecla de atalho \`Ctrl+Espaço\` para ativar e desativar a entrada em japonês."
  echo "-> Para mais personalizações, execute \`fcitx5-configtool\` no terminal."
  echo "------------------------------------------------------------------"

  read -p "Você deseja reiniciar o computador agora? (s/N): " choice
  case "$choice" in
  s | S)
    log_info "Reiniciando o sistema..."
    reboot
    ;;
  *)
    log_warning "Reinicialização cancelada. Por favor, reinicie manualmente."
    ;;
  esac
}

# --- Ponto de Entrada do Script ---
main
